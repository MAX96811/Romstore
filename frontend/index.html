<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RomStore Library</title>
        <style>
@import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800;900&family=Space+Mono:wght@400;700&display=swap');

:root {
  --bg-color: #080808;
  --bg-elev: #0f0f0f;
  --bg-panel: #121212;
  --card-bg: #141414;
  --card-border: #232323;
  --text-color: #f4f4f4;
  --text-dim: #9a9a9a;
  --text-soft: #c8c8c8;
  --accent: #ff6600;
  --accent-soft: #ff8a3d;
  --accent-glow: rgba(255, 102, 0, 0.35);
  --btn-bg: #ff6600;
  --btn-text: #111111;
  --success: #33d17a;
  --error: #ff5f5f;
  --shadow-lg: 0 20px 48px rgba(0, 0, 0, 0.5);
  --radius-sm: 8px;
  --radius-md: 12px;
  --radius-lg: 18px;
}

* { box-sizing: border-box; }

html, body { min-height: 100%; }

body {
  margin: 0;
  color: var(--text-color);
  font-family: 'Inter', sans-serif;
  background:
    radial-gradient(circle at 15% -10%, rgba(255, 102, 0, 0.16), transparent 35%),
    radial-gradient(circle at 95% 5%, rgba(255, 102, 0, 0.10), transparent 30%),
    linear-gradient(180deg, #0b0b0b 0%, #070707 100%);
  overflow-x: hidden;
}

::selection { background: var(--accent); color: #fff; }

@keyframes fadeInUp {
  from { opacity: 0; transform: translateY(24px); }
  to { opacity: 1; transform: translateY(0); }
}

@keyframes pulseGlow {
  0%, 100% { box-shadow: 0 0 0 rgba(255, 102, 0, 0); }
  50% { box-shadow: 0 0 24px var(--accent-glow); }
}

@keyframes toastIn {
  from { transform: translateY(20px); opacity: 0; }
  to { transform: translateY(0); opacity: 1; }
}

header {
  position: sticky;
  top: 0;
  z-index: 100;
  display: flex;
  flex-direction: column;
  gap: 14px;
  padding: 20px 36px;
  border-bottom: 1px solid #1d1d1d;
  background: rgba(8, 8, 8, 0.92);
  backdrop-filter: blur(8px);
}

.header-top {
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 16px;
}

h1 {
  margin: 0;
  color: var(--accent);
  text-transform: uppercase;
  font-size: clamp(1.6rem, 2.6vw, 2.2rem);
  letter-spacing: 0.08em;
  font-weight: 900;
}

#current-user-label,
#lib-mode {
  color: var(--text-dim) !important;
  font-family: 'Space Mono', monospace;
}

.tabs {
  display: flex;
  align-items: center;
  gap: 10px;
}

.tabs button {
  border: 1px solid #242424;
  background: #101010;
  color: var(--text-dim);
  font-family: 'Space Mono', monospace;
  font-size: 0.82rem;
  text-transform: uppercase;
  letter-spacing: 0.06em;
  border-radius: 999px;
  padding: 9px 16px;
  cursor: pointer;
  transition: all 0.2s ease;
}

.tabs button:hover {
  color: #fff;
  border-color: #3a3a3a;
  transform: translateY(-1px);
}

.tabs button.active {
  color: #fff;
  border-color: var(--accent);
  background: linear-gradient(180deg, #29180c, #1a120d);
  box-shadow: inset 0 0 0 1px rgba(255, 102, 0, 0.25);
}

.controls {
  width: 100%;
  padding-top: 12px;
  border-top: 1px solid #1e1e1e;
  display: flex;
  justify-content: space-between;
  align-items: center;
  gap: 10px;
  flex-wrap: wrap;
}

.filter-group {
  display: flex;
  align-items: center;
  gap: 9px;
  max-width: 58%;
  overflow-x: auto;
  padding-bottom: 5px;
}

.filter-group::-webkit-scrollbar { height: 5px; }
.filter-group::-webkit-scrollbar-thumb { background: #2c2c2c; border-radius: 999px; }

.filter-chip {
  border: 1px solid #262626;
  background: #111111;
  color: var(--text-dim);
  font-family: 'Space Mono', monospace;
  font-size: 0.75rem;
  letter-spacing: 0.05em;
  text-transform: uppercase;
  border-radius: 999px;
  padding: 6px 12px;
  white-space: nowrap;
  cursor: pointer;
  transition: all 0.2s ease;
}

.filter-chip:hover { color: #fff; border-color: #3b3b3b; }

.filter-chip.active {
  color: #fff;
  background: #1c120c;
  border-color: var(--accent);
  box-shadow: inset 0 0 0 1px rgba(255, 102, 0, 0.25);
}

.view-options {
  display: flex;
  align-items: center;
  gap: 10px;
  flex-wrap: wrap;
}

select,
.toggle-btn,
#search-filter,
input[type='text'],
input[type='password'],
.input-group input,
.input-group select {
  background: #111111;
  color: #fff;
  border: 1px solid #2a2a2a;
  border-radius: var(--radius-sm);
  padding: 8px 12px;
  font-size: 0.9em;
  transition: border-color 0.2s ease, box-shadow 0.2s ease;
}

select:focus,
.toggle-btn:focus,
#search-filter:focus,
input[type='text']:focus,
input[type='password']:focus,
.input-group input:focus,
.input-group select:focus {
  outline: none;
  border-color: var(--accent);
  box-shadow: 0 0 0 2px rgba(255, 102, 0, 0.2);
}

.toggle-btn.active {
  color: #fff;
  border-color: var(--accent);
  background: #1a120d;
}

.content-area { padding: 34px; }

.section-header {
  margin: 28px 0 18px;
  padding-bottom: 8px;
  color: #fff;
  font-family: 'Space Mono', monospace;
  font-size: 1rem;
  text-transform: uppercase;
  letter-spacing: 0.06em;
  border-bottom: 1px solid #232323;
  animation: fadeInUp 0.35s ease both;
}

.section-header:first-child { margin-top: 0; }

.library-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(204px, 1fr));
  gap: 24px;
}

.game-card {
  position: relative;
  display: flex;
  flex-direction: column;
  cursor: pointer;
  animation: fadeInUp 0.28s ease both;
}

.game-card:hover { transform: translateY(-3px); }

.art-wrapper {
  position: relative;
  width: 100%;
  padding-top: 140%;
  overflow: hidden;
  border-radius: var(--radius-md);
  background: linear-gradient(165deg, #171717 0%, #101010 100%);
  border: 1px solid var(--card-border);
  box-shadow: var(--shadow-lg);
}

.game-art {
  position: absolute;
  inset: 0;
  width: 100%;
  height: 100%;
  object-fit: cover;
}

.icon-placeholder {
  position: absolute;
  inset: 0;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 60px;
  color: #ddd;
  background: radial-gradient(circle at 30% 20%, #252525, #121212 55%);
}

.card-overlay {
  position: absolute;
  inset: 0;
  background: linear-gradient(180deg, rgba(12, 12, 12, 0.15) 8%, rgba(8, 8, 8, 0.95) 72%);
  padding: 16px;
  opacity: 0;
  pointer-events: none;
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  text-align: center;
  transition: opacity 0.2s ease;
}

.game-card.active .card-overlay { opacity: 1; pointer-events: auto; }

.overlay-info { margin-bottom: 16px; }

.overlay-system {
  color: var(--accent);
  font-size: 0.76rem;
  font-family: 'Space Mono', monospace;
  text-transform: uppercase;
  letter-spacing: 0.07em;
  margin-bottom: 6px;
}

.overlay-meta {
  color: var(--text-soft);
  opacity: 0.88;
  font-size: 0.82rem;
  margin-top: 3px;
}

.download-btn,
.action-btn,
.action-btn-small {
  border: 1px solid var(--accent);
  background: var(--btn-bg);
  color: var(--btn-text);
  border-radius: 9px;
  padding: 9px 15px;
  font-weight: 800;
  text-decoration: none;
  cursor: pointer;
  letter-spacing: 0.02em;
  transition: transform 0.15s ease, filter 0.15s ease;
}

.download-btn:hover,
.action-btn:hover,
.action-btn-small:hover {
  transform: translateY(-1px);
  filter: brightness(1.05);
}

.game-title-below {
  margin-top: 11px;
  color: #fff;
  font-size: 0.92rem;
  font-weight: 700;
  text-align: center;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  padding: 0 4px;
}

.edit-btn {
  position: absolute;
  top: 9px;
  right: 9px;
  z-index: 10;
  width: 30px;
  height: 30px;
  border: 1px solid #3b3b3b;
  border-radius: 999px;
  background: rgba(12, 12, 12, 0.85);
  color: #fff;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
}

.modal {
  position: fixed;
  inset: 0;
  z-index: 220;
  display: none;
  align-items: center;
  justify-content: center;
  background: rgba(4, 4, 4, 0.84);
}

.modal-content {
  width: 540px;
  max-width: 95%;
  max-height: 90vh;
  overflow-y: auto;
  border-radius: var(--radius-lg);
  border: 1px solid #2a2a2a;
  background:
    radial-gradient(circle at 88% -10%, rgba(255, 102, 0, 0.12), transparent 28%),
    linear-gradient(180deg, #121212 0%, #0d0d0d 100%);
  color: #f0f0f0;
  padding: 22px;
  box-shadow: var(--shadow-lg);
}

.modal-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 14px;
  font-family: 'Space Mono', monospace;
  text-transform: uppercase;
  letter-spacing: 0.05em;
}

.close-btn {
  color: #bbb;
  font-size: 28px;
  font-weight: bold;
  cursor: pointer;
  line-height: 1;
}
.close-btn:hover { color: #fff; }

.input-group { margin-bottom: 12px; }
.input-group label { display: block; margin-bottom: 6px; color: #ddd; font-size: 0.86rem; }

.results-list { margin-top: 14px; display: grid; gap: 9px; }
.result-item {
  border: 1px solid #292929;
  border-radius: 10px;
  background: #121212;
  padding: 9px;
  display: flex;
  gap: 12px;
  align-items: center;
}
.result-img { width: 56px; height: 56px; object-fit: cover; border-radius: 6px; }
.result-title { font-weight: 700; color: #fff; }
.result-year { color: #aaa; font-size: 0.85rem; }

.version-row {
  display: flex;
  justify-content: space-between;
  align-items: center;
  border-bottom: 1px solid #222;
  padding: 11px 6px;
}

.version-info { color: #d2d2d2; font-size: 0.9rem; }

.library-list { display: flex; flex-direction: column; gap: 9px; }

.game-row {
  display: flex;
  align-items: center;
  gap: 14px;
  border: 1px solid #232323;
  border-radius: 12px;
  background: #111111;
  padding: 10px;
  transition: border-color 0.2s ease, transform 0.2s ease;
}

.game-row:hover { border-color: #343434; transform: translateY(-1px); }
.game-row.active { border-color: var(--accent); animation: pulseGlow 1.4s ease-in-out infinite; }

.game-row .row-thumb { width: 62px; height: 62px; object-fit: cover; border-radius: 8px; background: #151515; }
.game-row .row-info { flex: 1; min-width: 0; }
.game-row .row-title { font-size: 1rem; font-weight: 700; color: #fff; }
.game-row .row-meta { display: flex; gap: 9px; color: #aaa; font-size: 0.82rem; flex-wrap: wrap; }
.game-row .row-actions { display: flex; align-items: center; gap: 8px; }

.progress-container, .progress-bar-bg {
  width: 100%;
  height: 7px;
  border-radius: 999px;
  background: #252525;
  overflow: hidden;
}

.progress-bar,


.progress-container { display: none; }
.downloading .progress-container { display: block; }

.progress-label {
  margin-bottom: 6px;
  font-family: 'Space Mono', monospace;
  color: #cbcbcb;
  display: flex;
  justify-content: space-between;
  font-size: 0.78rem;
}

.toast {
  position: fixed;
  right: 18px;
  bottom: 18px;
  min-width: 250px;
  z-index: 320;
  border-radius: 10px;
  border: 1px solid #343434;
  border-left: 4px solid var(--accent);
  background: #101010;
  color: #fff;
  padding: 12px 14px;
  box-shadow: var(--shadow-lg);
  animation: toastIn 0.24s ease;
}

.conflict-item {
  border: 1px solid #2b2b2b;
  border-radius: 12px;
  background: #111111;
  padding: 13px;
  display: flex;
  flex-direction: column;
  gap: 9px;
}

.conflict-title {
  border-bottom: 1px solid #252525;
  padding-bottom: 7px;
  color: #fff;
  font-weight: 700;
}

.conflict-compare {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  gap: 10px;
}

.conflict-side { flex: 1; }
.conflict-side.local { border-right: 1px solid #282828; padding-right: 12px; }
.conflict-side.cloud { text-align: right; padding-left: 12px; }

.c-label {
  color: #a9a9a9;
  text-transform: uppercase;
  letter-spacing: 0.06em;
  font-size: 0.73rem;
  margin-bottom: 4px;
}

.c-date { color: #f0f0f0; font-family: 'Space Mono', monospace; font-size: 0.82rem; }

.c-badge {
  display: inline-block;
  margin-top: 6px;
  padding: 3px 8px;
  border-radius: 999px;
  font-size: 0.69rem;
  font-weight: 700;
}

.c-newer { background: rgba(51, 209, 122, 0.2); color: #9ef1c5; border: 1px solid rgba(51, 209, 122, 0.35); }
.c-older { background: rgba(255, 95, 95, 0.2); color: #ffb1b1; border: 1px solid rgba(255, 95, 95, 0.35); }

.conflict-actions { display: flex; justify-content: center; gap: 10px; margin-top: 8px; }

#resolve-all-local,
#resolve-all-cloud {
  color: #fff !important;
  border-width: 1px !important;
  border-style: solid !important;
}

#resolve-all-local {
  background: #27445a !important;
  border-color: #355c79 !important;
}

#resolve-all-cloud {
  background: #2f5b3f !important;
  border-color: #3e7954 !important;
}

#resolve-all-local:hover,
#resolve-all-cloud:hover { filter: brightness(1.08); }

@media (max-width: 900px) {
  header { padding: 16px; }
  .header-top { align-items: flex-start; flex-direction: column; }
  .controls { align-items: stretch; }
  .filter-group { max-width: 100%; }
  .view-options { width: 100%; }
  .content-area { padding: 18px; }
  .library-grid { grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 16px; }
}
</style>
</head>
<body>

<header>
    <div class="header-top">
        <h1>ROMSTORE</h1>
        <div style="display:flex; gap: 15px; align-items: center;">
            <button onclick="logout()" class="action-btn" style="background:transparent; border: 1px solid #c23c2a; color: #c23c2a;">Logout</button>
            <button onclick="openSettings()" class="action-btn" style="background:transparent; border: 1px solid #3a2b1f; color: #9a9a9a;">‚öô Settings</button>
            <nav class="tabs">
                <button onclick="changeTab('games')" id="tab-games" class="active">Games</button>
                <button onclick="changeTab('saves')" id="tab-saves">Saves</button>
                <button onclick="changeTab('bios')" id="tab-bios">Bios</button>
                <button onclick="changeTab('admin')" id="tab-admin" style="display:none;">Admin</button>
            </nav>
        </div>
        <div id="current-user-label" style="color: #9a9a9a; font-size: 0.9em;">Library Mode: Native</div>
    </div>
    
    <div class="controls">
        <div class="filter-group" id="filter-container">
            <span style="color:#9a9a9a; font-size:0.9em;">Loading filters...</span>
        </div>

        <div class="view-options">
            <input type="text" id="search-filter" placeholder="Search files..." oninput="applyViewSettings()" style="background:#121212; color:#fff; border:1px solid #3a2b1f; padding:5px 10px; border-radius:3px; font-size:0.9em;">
            <select id="sort-select" onchange="applyViewSettings()">
                <option value="name_asc">Name (A-Z)</option>
                <option value="name_desc">Name (Z-A)</option>
                <option value="date_new">Date Added (Newest)</option>
                <option value="date_old">Date Added (Oldest)</option>
            </select>
            <button id="group-toggle" class="toggle-btn" onclick="toggleGrouping()">Group by Console</button>
        </div>
    </div>
</header>

<div id="main-content" class="content-area">
    <div style="text-align:center;">Scanning...</div>
</div>

<!-- Auth Modal -->
<div id="auth-modal" class="modal" style="display:flex; backdrop-filter: blur(10px);">
    <div class="modal-content" style="width: 350px;">
        <div class="modal-header">
            <span id="auth-title">Login</span>
        </div>
        <p id="auth-desc" style="font-size: 0.9em; color: #9a9a9a; margin-bottom: 20px;">Please login to access your library.</p>
        
        <div class="input-group">
            <label>Username</label>
            <input type="text" id="auth-username" placeholder="Username">
        </div>
        <div class="input-group">
            <label id="auth-password-label">Password</label>
            <input type="password" id="auth-password" placeholder="Password">
        </div>
        <div class="input-group" id="auth-new-password-group" style="display:none;">
            <label id="auth-new-password-label">New Password</label>
            <input type="password" id="auth-new-password" placeholder="New Password">
        </div>
        <button onclick="handleAuth()" id="auth-btn" class="action-btn" style="width:100%">Login</button>
    </div>
</div>

<!-- Settings Modal -->
<div id="settings-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <span>Settings</span>
            <span class="close-btn" onclick="closeModal('settings-modal')">&times;</span>
        </div>
        
        <div style="margin-bottom: 25px;">
            <p style="font-size:0.95em; color:#fff; margin-bottom:10px;">Bulk Upload Games</p>
            <div class="input-group">
                <button onclick="document.getElementById('file-input').click()" class="action-btn" style="background:#3a2b1f; width:100%;">üìÅ Select Files</button>
                <input type="file" id="file-input" multiple style="display:none;" onchange="handleFileSelect()">
            </div>
            
            <div id="upload-controls" style="display:none;">
                <div class="input-group">
                    <label>Target Console/Folder</label>
                    <select id="upload-system-select">
                        <!-- Populated dynamically -->
                    </select>
                </div>
                <button onclick="startBulkUpload()" id="start-upload-btn" class="action-btn" style="width:100%">üöÄ Start Uploading (<span id="file-count-label">0</span> files)</button>
                
                <div id="upload-progress-area" style="display:none;">
                    <div id="current-file-name">Preparing...</div>
                    
                    <div class="progress-label">
                        <span>Current File Progress</span>
                        <span id="current-file-percent">0%</span>
                    </div>
                    <div class="progress-bar-bg">
                        <div id="current-file-progress-fill" class="progress-bar-fill"></div>
                    </div>

                    <div class="progress-label">
                        <span>Overall Progress</span>
                        <span id="overall-progress-text">0/0</span>
                    </div>
                    <div class="progress-bar-bg">
                        <div id="overall-progress-fill" class="progress-bar-fill"></div>
                    </div>
                </div>
            </div>
        </div>

        <div style="border-top: 1px solid #3a2b1f; padding-top: 20px; margin-bottom: 25px;">
            <p style="font-size:0.95em; color:#fff; margin-bottom:10px;">IGDB Metadata API</p>
            <div class="input-group">
                <label>Client ID</label>
                <input type="text" id="client-id" placeholder="Twitch Client ID">
            </div>
            <div class="input-group">
                <label>Client Secret</label>
                <input type="password" id="client-secret" placeholder="Twitch Client Secret">
            </div>
            <button onclick="saveSettings()" class="action-btn" style="width:100%">Save Credentials</button>
        </div>
        
        <div style="border-top: 1px solid #3a2b1f; padding-top: 20px;">
            <p style="font-size:0.95em; color:#fff; margin-bottom:10px;">Maintenance</p>
            <button onclick="autoScanLibrary()" class="action-btn" id="auto-scan-btn" style="width:100%">‚ú® Auto Scan Missing Metadata</button>
        </div>
    </div>
</div>

<!-- Metadata Modal -->
<div id="metadata-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <span id="modal-title">Edit Metadata</span>
            <span class="close-btn" onclick="closeModal('metadata-modal')">&times;</span>
        </div>
        <div style="display:flex; gap:10px;">
            <input type="text" id="search-query" style="flex:1; padding:8px; border-radius:3px; border:1px solid #3a2b1f; background:#121212; color:#fff;" placeholder="Search Game Name...">
            <button onclick="searchMetadata()" class="action-btn">Search</button>
        </div>
        <div style="margin-top:10px; display:none;" id="skip-container">
            <button onclick="skipCurrentAutoGame()" class="action-btn" style="background:#c23c2a; width:100%;">Skip This Game</button>
        </div>
        <div id="results-list" class="results-list">
            <!-- Results here -->
        </div>
    </div>
</div>

<div id="toast-container"></div>

<script>
    // State Persistence
    function saveUIState() {
        const state = {
            currentTab,
            activeFilters: Array.from(activeFilters),
            isGrouped,
            sortMode: document.getElementById('sort-select').value,
            searchVal: document.getElementById('search-filter').value
        };
        localStorage.setItem('romstore_ui_state', JSON.stringify(state));
    }

    function loadUIState() {
        const saved = localStorage.getItem('romstore_ui_state');
        if (!saved) return;
        try {
            const state = JSON.parse(saved);
            currentTab = state.currentTab || 'games';
            activeFilters = new Set(state.activeFilters || []);
            isGrouped = !!state.isGrouped;
            
            // Apply to DOM
            document.querySelectorAll('.tabs button').forEach(b => b.classList.remove('active'));
            document.getElementById(`tab-${currentTab}`).classList.add('active');
            document.getElementById('sort-select').value = state.sortMode || 'name_asc';
            document.getElementById('search-filter').value = state.searchVal || '';
            document.getElementById('group-toggle').classList.toggle('active', isGrouped);
        } catch (e) { console.error("Failed to load state", e); }
    }

    // State
    let currentTab = 'games';
    let rawData = [];
    let activeFilters = new Set(); 
    let isGrouped = false;
    let editingGamePath = null;
    let currentUser = null;
    
    // Auto Scan State
    let isAutoScanning = false;
    let autoScanQueue = [];
    let autoScanResolver = null;

    // Upload State
    let selectedFiles = [];
    let isSetupMode = false;
    let isPasswordChangeMode = false;

    function setAuthMode(mode, user = null) {
        const titleEl = document.getElementById('auth-title');
        const descEl = document.getElementById('auth-desc');
        const btnEl = document.getElementById('auth-btn');
        const usernameEl = document.getElementById('auth-username');
        const passwordLabelEl = document.getElementById('auth-password-label');
        const passwordEl = document.getElementById('auth-password');
        const newGroupEl = document.getElementById('auth-new-password-group');
        const newPasswordEl = document.getElementById('auth-new-password');

        isSetupMode = mode === 'setup';
        isPasswordChangeMode = mode === 'password_change';
        newPasswordEl.value = '';
        passwordEl.value = '';

        if (mode === 'setup') {
            titleEl.innerText = 'Initial Setup';
            descEl.innerText = 'Create your administrator account.';
            btnEl.innerText = 'Create Account';
            usernameEl.disabled = false;
            usernameEl.value = '';
            passwordLabelEl.innerText = 'Password';
            passwordEl.placeholder = 'Password';
            newGroupEl.style.display = 'none';
            return;
        }

        if (mode === 'password_change') {
            titleEl.innerText = 'Password Update Required';
            descEl.innerText = 'Use your temporary password, then set your own.';
            btnEl.innerText = 'Update Password';
            usernameEl.disabled = true;
            usernameEl.value = user ? user.username : '';
            passwordLabelEl.innerText = 'Temporary Password';
            passwordEl.placeholder = 'Temporary Password';
            newGroupEl.style.display = 'block';
            return;
        }

        titleEl.innerText = 'Login';
        descEl.innerText = 'Please login to access your library.';
        btnEl.innerText = 'Login';
        usernameEl.disabled = false;
        usernameEl.value = '';
        passwordLabelEl.innerText = 'Password';
        passwordEl.placeholder = 'Password';
        newGroupEl.style.display = 'none';
    }

    function updateRoleUI() {
        const adminTab = document.getElementById('tab-admin');
        const userLabel = document.getElementById('current-user-label');
        const isAdmin = !!(currentUser && currentUser.role === 'admin');

        adminTab.style.display = isAdmin ? 'inline-block' : 'none';
        if (currentUser) {
            userLabel.innerText = `${currentUser.username} (${currentUser.role || 'user'})`;
        } else {
            userLabel.innerText = 'Library Mode: Native';
        }

        if (!isAdmin && currentTab === 'admin') {
            currentTab = 'games';
        }

        document.querySelector('.controls').style.display = currentTab === 'admin' ? 'none' : 'flex';
        document.querySelectorAll('.tabs button').forEach(b => b.classList.remove('active'));
        const activeTabEl = document.getElementById(`tab-${currentTab}`);
        if (activeTabEl) activeTabEl.classList.add('active');
    }

    document.addEventListener('DOMContentLoaded', () => {
        checkAuth();
    });

    async function checkAuth() {
        try {
            const res = await fetch('/api/auth/status');
            const data = await res.json();
            
            if (data.needsSetup) {
                currentUser = null;
                updateRoleUI();
                setAuthMode('setup');
                document.getElementById('auth-modal').style.display = 'flex';
            } else if (!data.authenticated) {
                currentUser = null;
                updateRoleUI();
                setAuthMode('login');
                document.getElementById('auth-modal').style.display = 'flex';
            } else {
                currentUser = data.user || null;
                updateRoleUI();
                if (currentUser && currentUser.mustChangePassword) {
                    setAuthMode('password_change', currentUser);
                    document.getElementById('auth-modal').style.display = 'flex';
                    return;
                }
                document.getElementById('auth-modal').style.display = 'none';
                loadUIState();
                updateRoleUI();
                loadLibrary();
            }
        } catch (e) {
            console.error('Auth check failed', e);
        }
    }

    async function handleAuth() {
        const username = document.getElementById('auth-username').value;
        const password = document.getElementById('auth-password').value;
        const newPassword = document.getElementById('auth-new-password').value;
        
        if (isPasswordChangeMode) {
            if (!password || !newPassword) return showToast('Please enter both password fields', 'error');
            if (newPassword.length < 6) return showToast('New password must be at least 6 characters', 'error');
        } else {
            if (!username || !password) return showToast('Please enter both fields', 'error');
        }

        const endpoint = isSetupMode ? '/api/auth/setup' : (isPasswordChangeMode ? '/api/auth/password' : '/api/auth/login');
        const body = isPasswordChangeMode
            ? { currentPassword: password, newPassword }
            : { username, password };
        
        try {
            const res = await fetch(endpoint, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(body)
            });
            
            if (res.ok) {
                if (isSetupMode) showToast('Account Created!', 'success');
                else if (isPasswordChangeMode) showToast('Password updated.', 'success');
                else showToast('Welcome back!', 'success');
                checkAuth();
            } else {
                const err = await res.json();
                showToast(err.error || 'Authentication failed', 'error');
            }
        } catch (e) {
            showToast('Server error during authentication', 'error');
        }
    }

    async function logout() {
        try {
            await fetch('/api/auth/logout', { method: 'POST' });
            location.reload();
        } catch (e) {
            showToast('Logout failed', 'error');
        }
    }

    // --- Notifications ---
    function showToast(message, type = 'info') {
        const container = document.getElementById('toast-container');
        const toast = document.createElement('div');
        toast.className = `toast ${type}`;
        toast.innerText = message;
        container.appendChild(toast);
        setTimeout(() => {
            toast.style.opacity = '0';
            setTimeout(() => toast.remove(), 300);
        }, 3000);
    }

    // --- Modals ---
    function closeModal(id) { 
        document.getElementById(id).style.display = 'none'; 
        if (id === 'metadata-modal' && isAutoScanning && autoScanResolver) {
            skipCurrentAutoGame();
        }
    }
    
    window.onclick = function(event) {
        if (event.target.classList.contains('modal')) closeModal(event.target.id);
    }

    async function openSettings() {
        document.getElementById('settings-modal').style.display = 'flex';
        
        // Populate system selector for upload from backend
        try {
            const sysRes = await fetch('/api/systems');
            const systems = await sysRes.json();
            const select = document.getElementById('upload-system-select');
            select.innerHTML = systems.map(s => `<option value="${s}">${s}</option>`).join('');
            select.innerHTML += `<option value="custom">-- New Folder --</option>`;
        } catch (e) {
            console.error("Failed to load systems", e);
        }

        try {
            const res = await fetch('/api/settings/keys');
            const data = await res.json();
            document.getElementById('client-id').value = data.hasClientId ? '******' : '';
            document.getElementById('client-secret').value = data.hasClientSecret ? '******' : '';
        } catch(e) { console.error(e); }
    }

    async function saveSettings() {
        const clientId = document.getElementById('client-id').value;
        const clientSecret = document.getElementById('client-secret').value;
        if(clientId === '******' || clientSecret === '******') return showToast('Please enter valid keys', 'error');
        
        try {
            await fetch('/api/settings/keys', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ clientId, clientSecret })
            });
            showToast('Settings Saved!', 'success');
        } catch(e) { showToast('Error saving settings', 'error'); }
    }

    // --- Bulk Upload Logic ---
    function handleFileSelect() {
        const input = document.getElementById('file-input');
        selectedFiles = Array.from(input.files);
        if (selectedFiles.length > 0) {
            document.getElementById('upload-controls').style.display = 'block';
            document.getElementById('file-count-label').innerText = selectedFiles.length;
        }
    }

    async function startBulkUpload() {
        const sysSelect = document.getElementById('upload-system-select');
        let system = sysSelect.value;
        
        if (system === 'custom') {
            system = prompt("Enter new folder name (e.g. 'ps2', 'snes'):");
            if (!system) return;
            system = system.toLowerCase().replace(/[^a-z0-9]/g, '');
        }

        const btn = document.getElementById('start-upload-btn');
        const progressArea = document.getElementById('upload-progress-area');
        const currentProgressFill = document.getElementById('current-file-progress-fill');
        const overallProgressFill = document.getElementById('overall-progress-fill');
        const currentFileText = document.getElementById('current-file-name');
        const currentFilePercentText = document.getElementById('current-file-percent');
        const overallText = document.getElementById('overall-progress-text');

        btn.disabled = true;
        progressArea.style.display = 'block';
        
        let successCount = 0;
        for (let i = 0; i < selectedFiles.length; i++) {
            const file = selectedFiles[i];
            
            // Update Overall UI
            overallText.innerText = `${i + 1} / ${selectedFiles.length}`;
            overallProgressFill.style.width = `${(i / selectedFiles.length) * 100}%`;
            currentFileText.innerText = `File: ${file.name}`;
            currentFilePercentText.innerText = `0%`;
            currentProgressFill.style.width = `0%`;

            try {
                await new Promise((resolve, reject) => {
                    const xhr = new XMLHttpRequest();
                    const formData = new FormData();
                    formData.append('file', file);

                    xhr.upload.onprogress = (e) => {
                        if (e.lengthComputable) {
                            const percent = Math.round((e.loaded / e.total) * 100);
                            currentProgressFill.style.width = `${percent}%`;
                            currentFilePercentText.innerText = `${percent}%`;
                        }
                    };

                    xhr.onload = () => {
                        if (xhr.status === 200) {
                            successCount++;
                            resolve();
                        } else {
                            reject(new Error(`Upload failed with status ${xhr.status}`));
                        }
                    };

                    xhr.onerror = () => reject(new Error('Network error during upload'));
                    
                    xhr.open('POST', `/api/upload?path=${system}`, true);
                    xhr.send(formData);
                });
            } catch (e) {
                console.error(`Upload failed for ${file.name}`, e);
                showToast(`Failed: ${file.name}`, 'error');
            }
        }

        overallProgressFill.style.width = `100%`;
        currentFileText.innerText = `All uploads completed!`;
        showToast(`Successfully uploaded ${successCount} files.`, 'success');
        
        setTimeout(() => {
            document.getElementById('upload-controls').style.display = 'none';
            progressArea.style.display = 'none';
            btn.disabled = false;
            loadLibrary();
        }, 2000);
    }

    // --- Metadata Logic ---
    function openMetadata(name, relPath) {
        if(isAutoScanning) return; 
        startMetadataFlow(name, relPath);
    }

    function openMetadataFromButton(btn) {
        const name = decodeURIComponent(btn.dataset.name);
        const path = decodeURIComponent(btn.dataset.path);
        openMetadata(name, path);
    }

    function startMetadataFlow(name, relPath, existingResults = null) {
        editingGamePath = relPath;
        document.getElementById('search-query').value = name;
        document.getElementById('results-list').innerHTML = '';
        document.getElementById('metadata-modal').style.display = 'flex';
        
        if (existingResults) {
            renderResults(existingResults);
            document.getElementById('modal-title').innerText = "Select Match (Conflict)";
            document.getElementById('skip-container').style.display = 'block';
        } else {
            document.getElementById('modal-title').innerText = "Edit Metadata";
            document.getElementById('skip-container').style.display = 'none';
            searchMetadata(); 
        }
    }

    async function searchMetadata() {
        const query = document.getElementById('search-query').value;
        const list = document.getElementById('results-list');
        list.innerHTML = '<div style="text-align:center; padding:20px;">Searching IGDB...</div>';
        
        try {
            const res = await fetch(`/api/metadata/search?q=${encodeURIComponent(query)}`);
            const data = await res.json();
            renderResults(data);
        } catch(e) {
            list.innerHTML = '<div style="text-align:center; color:#ff6b6b;">Search failed. Check API Keys.</div>';
        }
    }

    function renderResults(data) {
        const list = document.getElementById('results-list');
        list.innerHTML = '';
        if (data.error) {
            list.innerHTML = `<div style="text-align:center; color:#ff6b6b;">${data.error}</div>`;
            return;
        }
        if (data.length === 0) {
            list.innerHTML = '<div style="text-align:center;">No results found.</div>';
            return;
        }
        data.forEach(game => {
            const year = game.first_release_date ? new Date(game.first_release_date * 1000).getFullYear() : 'N/A';
            const img = game.coverUrl || '';
            const item = document.createElement('div');
            item.className = 'result-item';
            item.onclick = () => applyMetadata(game, true); 
            item.innerHTML = `
                <img src="${img}" class="result-img" onerror="this.style.backgroundColor='#333'">
                <div class="result-info">
                    <div class="result-title">${game.name}</div>
                    <div class="result-year">${year} - ${game.platforms ? game.platforms[0].name : ''}</div>
                </div>
            `;
            list.appendChild(item);
        });
    }

    async function applyMetadata(igdbData, silent = false) {
        try {
            const res = await fetch('/api/metadata/apply', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ relPath: editingGamePath, igdbData })
            });
            if (res.ok) {
                if (!isAutoScanning) {
                    closeModal('metadata-modal');
                    loadLibrary(); 
                    showToast('Metadata Applied!', 'success');
                } else {
                    document.getElementById('metadata-modal').style.display = 'none';
                    if(autoScanResolver) autoScanResolver(true); 
                }
            } else {
                if(!silent) showToast('Failed to apply metadata.', 'error');
            }
        } catch(e) { showToast('Error applying metadata', 'error'); }
    }

    async function autoScanLibrary() {
        if(isAutoScanning) return;
        const btn = document.getElementById('auto-scan-btn');
        autoScanQueue = rawData.filter(g => !g.hasMetadata);
        if(autoScanQueue.length === 0) return showToast('All games already have metadata!', 'success');
        isAutoScanning = true;
        btn.innerText = "Scanning Queue...";
        btn.disabled = true;
        document.getElementById('settings-modal').style.display = 'none';
        let appliedCount = 0;
        showToast(`Auto-Scanning ${autoScanQueue.length} games...`, 'info');
        for (const game of autoScanQueue) {
            editingGamePath = game.relPath; 
            try {
                const res = await fetch(`/api/metadata/search?q=${encodeURIComponent(game.originalName || game.name)}`);
                const results = await res.json();
                if (results && results.length > 0) {
                    if (results.length === 1) {
                        await applyMetadata(results[0], true);
                        appliedCount++;
                    } else {
                        await new Promise(resolve => {
                            autoScanResolver = resolve;
                            startMetadataFlow(game.name, game.relPath, results);
                        });
                        appliedCount++;
                    }
                }
            } catch (err) { console.error(err); }
        }
        isAutoScanning = false;
        autoScanResolver = null;
        btn.innerText = "‚ú® Auto Scan Metadata";
        btn.disabled = false;
        loadLibrary();
        showToast(`Scan Complete! Updated ${appliedCount} games.`, 'success');
    }

    function skipCurrentAutoGame() {
        if(isAutoScanning && autoScanResolver) {
            document.getElementById('metadata-modal').style.display = 'none';
            autoScanResolver(false); 
        }
    }

    async function loadAdminPanel() {
        const content = document.getElementById('main-content');
        if (!currentUser || currentUser.role !== 'admin') {
            content.innerHTML = '<div style="text-align:center; color:#ff6b6b;">Admin access required.</div>';
            return;
        }

        content.innerHTML = '<div style="text-align:center;">Loading users...</div>';
        try {
            const res = await fetch('/api/admin/users');
            if (!res.ok) {
                const err = await res.json();
                throw new Error(err.error || 'Failed to load users');
            }

            const users = await res.json();
            const rows = users.map(u => `
                <tr>
                    <td style="padding:10px; border-bottom:1px solid #2b3d4d;">${u.username}</td>
                    <td style="padding:10px; border-bottom:1px solid #2b3d4d; text-transform:capitalize;">${u.role}</td>
                    <td style="padding:10px; border-bottom:1px solid #2b3d4d;">${u.mustChangePassword ? 'Yes' : 'No'}</td>
                    <td style="padding:10px; border-bottom:1px solid #2b3d4d;">${u.lastLoginAt ? new Date(u.lastLoginAt).toLocaleString() : 'Never'}</td>
                </tr>
            `).join('');

            content.innerHTML = `
                <div style="max-width:900px; margin:0 auto;">
                    <h2 style="margin-top:0;">Admin Panel</h2>
                    <p style="color:#9a9a9a; margin-top:0;">Create users with temporary passwords. New users must update password on first login.</p>
                    <div style="display:grid; grid-template-columns: 1fr 1fr 1fr auto; gap:10px; margin-bottom:20px;">
                        <input type="text" id="admin-new-username" placeholder="Username" style="background:#121212; color:#fff; border:1px solid #3a2b1f; padding:10px; border-radius:4px;">
                        <input type="text" id="admin-temp-password" placeholder="Temporary Password" style="background:#121212; color:#fff; border:1px solid #3a2b1f; padding:10px; border-radius:4px;">
                        <select id="admin-new-role" style="background:#121212; color:#fff; border:1px solid #3a2b1f; padding:10px; border-radius:4px;">
                            <option value="user">User</option>
                            <option value="admin">Admin</option>
                        </select>
                        <button id="admin-create-user-btn" class="action-btn">Create User</button>
                    </div>
                    <div style="background:#1c2f40; border:1px solid #2b3d4d; border-radius:6px; overflow:hidden;">
                        <table style="width:100%; border-collapse:collapse;">
                            <thead>
                                <tr style="background:#182937; text-align:left;">
                                    <th style="padding:10px;">Username</th>
                                    <th style="padding:10px;">Role</th>
                                    <th style="padding:10px;">Must Change Password</th>
                                    <th style="padding:10px;">Last Login</th>
                                </tr>
                            </thead>
                            <tbody>${rows}</tbody>
                        </table>
                    </div>
                </div>
            `;

            document.getElementById('admin-create-user-btn').onclick = createAdminUser;
        } catch (err) {
            content.innerHTML = `<div style="text-align:center; color:#ff6b6b;">${err.message}</div>`;
        }
    }

    async function createAdminUser() {
        const username = document.getElementById('admin-new-username').value.trim();
        const tempPassword = document.getElementById('admin-temp-password').value.trim();
        const role = document.getElementById('admin-new-role').value;
        if (!username || !tempPassword) {
            showToast('Username and temporary password are required', 'error');
            return;
        }
        if (tempPassword.length < 6) {
            showToast('Temporary password must be at least 6 characters', 'error');
            return;
        }

        try {
            const res = await fetch('/api/admin/users', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username, tempPassword, role })
            });
            const data = await res.json();
            if (!res.ok) {
                showToast(data.error || 'Failed to create user', 'error');
                return;
            }

            showToast(`User ${data.user.username} created`, 'success');
            loadAdminPanel();
        } catch (e) {
            showToast('Failed to create user', 'error');
        }
    }

    // --- Core Logic ---
    function changeTab(tab) {
        if (tab === 'admin' && (!currentUser || currentUser.role !== 'admin')) {
            showToast('Admin access required', 'error');
            return;
        }

        currentTab = tab;
        document.querySelectorAll('.tabs button').forEach(b => b.classList.remove('active'));
        document.getElementById(`tab-${tab}`).classList.add('active');
        document.querySelector('.controls').style.display = tab === 'admin' ? 'none' : 'flex';
        activeFilters.clear();
        document.getElementById('search-filter').value = '';
        saveUIState();
        loadLibrary(); 
    }

    function toggleGrouping() {
        isGrouped = !isGrouped;
        document.getElementById('group-toggle').classList.toggle('active', isGrouped);
        saveUIState();
        renderContent();
    }

    async function loadLibrary() {
        const content = document.getElementById('main-content');
        content.innerHTML = '<div style="text-align:center;">Scanning...</div>';

        if (currentTab === 'admin') {
            await loadAdminPanel();
            return;
        }

        try {
            const res = await fetch(`/api/${currentTab}?t=${Date.now()}`);
            if (res.status === 403) {
                const err = await res.json();
                if (err.mustChangePassword) {
                    checkAuth();
                    return;
                }
            }
            if (res.status === 401) return checkAuth();
            rawData = await res.json();
            rawData = rawData.map(item => {
                if (!item.system) {
                    const parts = item.relPath.split('/');
                    item.system = parts.length > 1 ? parts[0] : 'Unknown';
                }
                return item;
            });
            generateFilters();
            renderContent();
        } catch (err) {
            console.error(err);
            content.innerHTML = `<div style="text-align:center; color: #ff6b6b;">Error loading ${currentTab}</div>`;
        }
    }

    function generateFilters() {
        const container = document.getElementById('filter-container');
        container.innerHTML = '';
        const systems = [...new Set(rawData.map(item => item.system))].sort();
        if (systems.length === 0) {
            container.innerHTML = '<span style="color:#55687a; font-size:0.8em;">No systems found</span>';
            return;
        }
        const allChip = document.createElement('div');
        allChip.className = `filter-chip ${activeFilters.size === 0 ? 'active' : ''}`;
        allChip.textContent = 'All Systems';
        allChip.onclick = () => {
            activeFilters.clear();
            updateFilterVisuals();
            saveUIState();
            renderContent();
        };
        container.appendChild(allChip);
        systems.forEach(sys => {
            const chip = document.createElement('div');
            chip.className = `filter-chip ${activeFilters.has(sys) ? 'active' : ''}`;
            chip.textContent = sys;
            chip.onclick = () => {
                if (activeFilters.has(sys)) activeFilters.delete(sys);
                else activeFilters.add(sys);
                updateFilterVisuals();
                saveUIState();
                renderContent();
            };
            container.appendChild(chip);
        });
    }

    function updateFilterVisuals() {
        const chips = document.getElementById('filter-container').children;
        if (activeFilters.size === 0) chips[0].classList.add('active');
        else chips[0].classList.remove('active');
        for (let i = 1; i < chips.length; i++) {
            const sysName = chips[i].textContent;
            if (activeFilters.has(sysName)) chips[i].classList.add('active');
            else chips[i].classList.remove('active');
        }
    }

    function applyViewSettings() { 
        saveUIState();
        renderContent(); 
    }

    function renderContent() {
        const content = document.getElementById('main-content');
        content.innerHTML = '';
        let filtered = rawData;
        if (activeFilters.size > 0) filtered = rawData.filter(item => activeFilters.has(item.system));

        const searchVal = document.getElementById('search-filter').value.toLowerCase();
        if (searchVal) {
            filtered = filtered.filter(item => {
                const title = (item.gameTitle || item.name).toLowerCase();
                return title.includes(searchVal) || item.name.toLowerCase().includes(searchVal);
            });
        }

        if (filtered.length === 0) {
            content.innerHTML = '<div style="text-align:center; margin-top:20px;">No items match the current filters.</div>';
            return;
        }
        const sortMode = document.getElementById('sort-select').value;
        filtered.sort((a, b) => {
            const nameA = a.gameTitle || a.name;
            const nameB = b.gameTitle || b.name;
            if (sortMode === 'name_asc') return nameA.localeCompare(nameB);
            if (sortMode === 'name_desc') return nameB.localeCompare(nameA);
            if (sortMode === 'date_new') return new Date(b.mtime) - new Date(a.mtime);
            if (sortMode === 'date_old') return new Date(a.mtime) - new Date(b.mtime);
            return 0;
        });
        if (isGrouped) {
            const groups = {};
            filtered.forEach(item => {
                if (!groups[item.system]) groups[item.system] = [];
                groups[item.system].push(item);
            });
            const sortedKeys = Object.keys(groups).sort();
            sortedKeys.forEach(sys => {
                const header = document.createElement('div');
                header.className = 'section-header';
                header.textContent = sys;
                content.appendChild(header);
                const grid = document.createElement('div');
                grid.className = 'library-grid';
                groups[sys].forEach(item => grid.appendChild(createCard(item)));
                content.appendChild(grid);
            });
        } else {
            const grid = document.createElement('div');
            grid.className = 'library-grid';
            filtered.forEach(item => grid.appendChild(createCard(item)));
            content.appendChild(grid);
        }
    }

    function createCard(item) {
        const card = document.createElement('div');
        card.className = `game-card`;
        card.onclick = (e) => {
            if (e.target.tagName === 'A' || e.target.classList.contains('edit-btn')) return;
            card.classList.toggle('active');
        };

        const icon = currentTab === 'games' ? 'üíø' : (currentTab === 'saves' ? 'üíæ' : 'üîë');
        const dateStr = new Date(item.mtime).toLocaleDateString();
        
        let title = item.name;
        let subtitle = item.system;
        if (currentTab === 'saves' && item.gameTitle) {
            title = item.gameTitle;
            subtitle = item.name; 
        }

        let imageHtml = `<div class="icon-placeholder">${icon}</div>`;
        if (item.artworkPath) {
            const artUrl = `/api/artwork?path=${encodeURIComponent(item.artworkPath)}`;
            imageHtml = `<img src="${artUrl}" class="game-art" alt="${title}" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex'">
                         <div class="icon-placeholder" style="display:none">${icon}</div>`;
        }

        let editHtml = '';
        if (currentTab === 'games') {
            editHtml = `<button class="edit-btn" data-name="${encodeURIComponent(title)}" data-path="${encodeURIComponent(item.relPath)}" onclick="event.stopPropagation(); openMetadataFromButton(this)" title="Edit Metadata">‚úé</button>`;
        }

        card.innerHTML = `
            ${editHtml}
            <div class="art-wrapper">
                ${imageHtml}
                <div class="card-overlay">
                    <div class="overlay-info">
                        <div class="overlay-system">${subtitle}</div>
                        <div class="overlay-meta">Size: ${item.size}</div>
                        <div class="overlay-meta">Added: ${dateStr}</div>
                    </div>
                    <a href="/api/download?type=${currentTab}&path=${encodeURIComponent(item.relPath)}" class="download-btn">Download</a>
                </div>
            </div>
            <div class="game-title-below" title="${title}">${title}</div>
        `;
        return card;
    }
</script>

</body>
</html>



